!function(k){k.fn.dynamicForm=function(e,r,f,o){var a,c,i,l,u=k(this),n="input, checkbox, select, textarea,_token",h=[],s=[],d=[],g=0;function m(t){var e,n;return e=i.cloneWithAttribut(!0),"function"==typeof o.afterClone&&(n=o.afterClone(e)),!n&&void 0!==n||e.insertAfter(h[h.length-1]||u),e.getSource=function(){return u},e.attr("id")&&e.attr("id",e.attr("id")+h.length),e.effect&&o.createColor&&!t&&e.effect("highlight",{color:o.createColor},o.duration),0===h.length&&u.find(f).show(),e}function v(r){k(s).each(function(){var t=this.getPlusSelector(),e=this.getMinusSelector(),n=this.getOptions(),i=this.selector;r.find(this.selector).each(function(){n=k.extend({internalSubDynamicForm:!0,internalContainer:r,isInAClone:!0,outerCloneIndex:h.length,selector:i},n),k(this).dynamicForm(t,e,n)})})}function p(t){t.preventDefault(),this.removableClone.effect&&o.removeColor?(that=this).removableClone.effect("highlight",{color:o.removeColor},o.duration,function(){that.removableClone.remove()}):this.removableClone.remove(),removableCloneId=this.removableClone.attr("id"),checkId=k.inArray(parseInt(removableCloneId[removableCloneId.length-1]),d),d.splice(checkId,1),h.splice(k.inArray(this.removableClone,h),1),k(e).length?0===h.length?(u.find(r).show(),u.find(f).hide()):h[h.length-1].find(r).show():1===h.length?(h[0].find(r).show(),h[0].find(f).hide()):h[h.length-1].find(r).show()}function C(o,a){var c=/(.+\[[^\[\]]+\]\[)(\d+)(\]\[[^\[\]]+\])$/;o.find(n).each(function(){var t=k(this),e=t.attr("name"),n=(t.attr("origname"),t.attr("id")),i=n.slice(0,-1)+a,r=c.exec(e);t.attr("name",r[1]+a+r[3]),n&&(t.attr("origid",n),o.find("label[for='"+n+"']").each(function(){k(this).attr("for",i)}),t.attr("id",i))})}c=o.internalSubDynamicForm?(a=k(o.internalContainer).find(f),k(o.internalContainer).find(r)):(a=k(f),k(r)),o=k.extend({duration:1e3,normalizeFullForm:!0,isSubDynamicForm:!1},o),l=o.formPrefix||u.selector.replace(/\W/g,""),u.each(function(){k.extend(this,{addSubDynamicForm:function(t){s.push(t)},getFormPrefix:function(){return l},getSource:function(){return u}})});var b,y,S,x,F,D,t=!0;return k(this).parentsUntil("body").each(function(){if(k.isFunction(this.addSubDynamicForm)&&!o.isSubDynamicForm){t=!1,o.isSubDynamicForm=!0;k.extend({internalSubDynamicForm:!0,internalContainer:this},o);return this.addSubDynamicForm(u),l=this.getFormPrefix()+"[0]["+l+"]",!1}}),t&&!o.isInAClone&&(l=l+"["+l+"]"),o.isInAClone?(l=l||o.selector.replace(/\W/g,""),y=l,S=0,x=/(.+)\[([^\[\]]+)\]$/,(b=u).find(n).each(function(){var t=k(this),e=t.attr("name"),n=t.attr("id"),i=n+S,r=x.exec(e);t.attr("name",r[1]+"["+y+"]["+S+"]["+r[2]+"]"),n&&(t.attr("origid",n),b.find("label[for='"+n+"']").each(function(){k(this).attr("for",i)}),t.attr("id",i))})):(F=l,D=0,u.find(n).each(function(){var t=k(this),e=t.attr("name"),n=t.attr("origname"),i=t.attr("id");t.attr("origid"),n?t.attr("name",F+"["+D+"]["+n+"]"):(t.attr("origname",e),t.attr("name",F+"["+D+"]["+e+"]")),i&&(t.attr("origid",i),k("label[for='"+i+"']").each(function(){k(this).attr("origfor",i),k(this).attr("for",i+D)}),t.attr("id",i+D))})),t&&o.normalizeFullForm&&!o.isInAClone&&k(this).parentsUntil("form").each(function(){var t=k(this).parent().get(0);k(t).find(n).filter("[type!=submit]").each(function(){var t=k(this),e=t.attr("name"),n=t.attr("origname");t.attr("id"),t.attr("origid");n||(t.attr("origname",e),t.attr("name",l+"["+e+"]"))})}),isPlusDescendentOfTemplate=u.find("*").filter(function(){return this==c.get(0)}),isPlusDescendentOfTemplate=0<isPlusDescendentOfTemplate.length,a.hide(),isPlusDescendentOfTemplate?c.click(function(t,e){var n,i=h[h.length-1]||u;t.preventDefault(),d.push(g+1),g=d[d.length-1],i.find(f).show(),i.find(r).hide(),0===h.length&&u.find(f).hide(),n=m(e),c=n.find(r),(a=n.find(f)).get(0).removableClone=n,a.click(p),o.limit&&o.limit-2>h.length?c.show():c.hide(),a.show(),h.push(n),C(n,g),v(n)}):(c.click(function(t,e){var n;t.preventDefault(),0===h.length&&a.show(),n=m(e),o.limit&&o.limit-3<h.length&&c.hide(),h.push(n),C(n,h.length),v(n)}),a.click(function(t){t.preventDefault();var e=h.pop();0<=h.length&&(e.effect&&o.removeColor?(that=this,e.effect("highlight",{color:o.removeColor,mode:"hide"},o.duration,function(){e.remove()})):e.remove()),0===h.length&&a.hide(),c.show()})),k.extend(u,{getPlus:function(){return c},getPlusSelector:function(){return r},getMinus:function(){return a},getMinusSelector:function(){return f},getOptions:function(){return o},getClones:function(){return[u].concat(h)},getSource:function(){return u},inject:function(e){var h=0;k.each(e,k.proxy(function i(r,t){var o=this;0<r&&(g=r-1,o.getSource().getPlus().trigger("click",["disableEffect"]),0===h&&(o.get(0).getSource().remove(),o.get(0).getSource().getClones()[1].find(f).hide()));for(var n=o.get(0).getSource().getClones(),a=[],c=0;c<n.length;c++)k.each(e,function(t,e){a[t]=n[c]});var l=a[r];k.each(t,function(t,e){if(k.isArray(e))"function"==typeof(o=l.find("#"+t)).get(0).getSource&&k.each(e,k.proxy(i,o.get(0).getSource()));else{var n=a[r].find("[origname='"+t+"']");n&&("input"==n.get(0).tagName.toLowerCase()?"radio"==n.attr("type")?n.filter("[value='"+e+"']").attr("checked","checked"):"checkbox"==n.attr("type")?n.attr("checked","checked"):n.attr("value",e):"textarea"==n.get(0).tagName.toLowerCase()?n.text(e):"select"==n.get(0).tagName.toLowerCase()&&k(n.get(0)).find("option").each(function(){k(this).text()!=e&&k(this).attr("value")!=e||k(this).attr("selected","selected")}))}}),h++},u))}}),i=u.cloneWithAttribut(!0),o.data&&u.inject(o.data),u},jQuery.fn.cloneWithAttribut=function(t){if(jQuery.support.noCloneEvent)return k(this).clone(t);k(this).find("*").each(function(){k(this).data("name",k(this).attr("name"))});var e=k(this).clone(t);return e.find("*").each(function(){k(this).attr("name",k(this).data("name"))}),e}}(jQuery);